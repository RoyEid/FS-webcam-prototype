<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Webcam Interaction Prototype</title>

  <!-- Mobile: fullscreen + safe area -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />

  <link rel="icon" href="data:,">

  <style>
    :root {
      --pad: 14px;
      --radius: 14px;
      --glass: rgba(0, 0, 0, 0.45);
      --glass2: rgba(0, 0, 0, 0.62);
      --txt: rgba(255, 255, 255, 0.92);
      --txt2: rgba(255, 255, 255, 0.78);
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
      height: 100%;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* Keep canvas full screen */
    canvas {
      position: fixed !important;
      left: 0 !important;
      top: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
    }

    #ui {
      position: fixed;
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--glass);
      padding: 12px 14px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      max-width: min(640px, calc(100vw - 32px));
      user-select: none;
      z-index: 10;

      /* safe area for notches */
      top: calc(16px + env(safe-area-inset-top));
      left: calc(16px + env(safe-area-inset-left));
      right: auto;

      /* IMPORTANT: allow internal scroll if needed */
      max-height: calc(100vh - 32px - env(safe-area-inset-top));
      overflow: auto;
      box-sizing: border-box;
    }

    /* Header with minimize */
    #uiHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    #minBtn {
      appearance: none;
      border: 0;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.14);
      color: var(--txt);
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }

    #minBtn:active {
      transform: translateY(1px);
    }

    #uiBody {
      margin-top: 10px;
    }

    #row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    input[type="range"] {
      width: 230px;
    }

    #btnRow {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    button.uiBtn {
      appearance: none;
      border: 0;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.12);
      color: var(--txt);
      font-weight: 600;
      cursor: pointer;
    }

    button.uiBtn:hover {
      background: rgba(255, 255, 255, 0.18);
    }

    button.uiBtn:active {
      transform: translateY(1px);
    }

    #recBtn[data-rec="1"] {
      background: rgba(255, 80, 80, 0.22);
    }

    .tiny {
      opacity: 0.78;
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.35;
      color: var(--txt2);
    }

    /* Collapsed UI: keep header only */
    #ui.collapsed {
      background: var(--glass2);
      padding: 10px 12px;
      max-height: none;
      overflow: hidden;
      width: min(360px, calc(100vw - 32px));
    }

    #ui.collapsed #uiBody {
      display: none;
    }

    /* ---------------- MOBILE RESPONSIVE FIX (KEEP EVERYTHING) ---------------- */
    @media (max-width: 480px) {
      #ui {
        left: calc(10px + env(safe-area-inset-left));
        right: calc(10px + env(safe-area-inset-right));
        top: calc(10px + env(safe-area-inset-top));
        max-width: none;

        /* KEY: menu uses limited height so camera stays visible */
        max-height: 42vh;
        /* camera keeps ~58% visible */
        overflow: auto;

        padding: 10px 10px;
        border-radius: 14px;
        font-size: 13px;
      }

      input[type="range"] {
        width: 60vw;
        max-width: 260px;
      }

      /* buttons become 2 columns but KEEP ALL buttons */
      #btnRow {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      button.uiBtn {
        padding: 10px 10px;
        font-size: 13px;
      }

      /* KEEP instructions, but slightly smaller */
      .tiny {
        display: block;
        font-size: 11px;
      }
    }
  </style>
</head>

<body>
  <div id="ui">
    <div id="uiHeader">
      <div>
        <b>Webcam Interaction Prototype</b>
      </div>
      <button id="minBtn" type="button">Minimize</button>
    </div>

    <div id="uiBody">
      <div style="margin-top:6px;">
        Move in front of the camera to generate particles & reveal a pattern.
      </div>

      <div id="row">
        <span>Sensitivity</span>
        <input id="sens" type="range" min="10" max="80" value="35" />
        <span id="sensVal">35</span>
      </div>

      <div id="btnRow">
        <button class="uiBtn" id="calBtn" type="button">Calibrate (C)</button>
        <button class="uiBtn" id="recBtn" type="button" data-rec="0">Start Recording (P)</button>
        <button class="uiBtn" id="vidBtn" type="button">Toggle Video (V)</button>
        <button class="uiBtn" id="rstBtn" type="button">Reset Particles (R)</button>
        <button class="uiBtn" id="sndBtn" type="button">Sound: ON (S)</button>
        <button class="uiBtn" id="micBtn" type="button">Mic: OFF (M)</button>
      </div>

      <div class="tiny">
        Keys: <b>H</b> help • <b>V</b> video • <b>R</b> reset • <b>C</b> calibrate • <b>P</b> record • <b>S</b> sound •
        <b>M</b> mic<br>
        Phone: Tap once anywhere to unlock audio. Allow mic permission when asked.<br>
        Tip: If menu blocks the camera, tap <b>Minimize</b>.
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <script src="sketch.js"></script>

  <script>
    function refreshButtons() {
      const recBtn = document.getElementById("recBtn");
      if (typeof isRecording !== "undefined") {
        recBtn.dataset.rec = isRecording ? "1" : "0";
        recBtn.textContent = isRecording ? "Stop Recording (P)" : "Start Recording (P)";
      }
      if (typeof soundEnabled !== "undefined") {
        document.getElementById("sndBtn").textContent = soundEnabled ? "Sound: ON (S)" : "Sound: OFF (S)";
      }
      if (typeof micEnabled !== "undefined") {
        document.getElementById("micBtn").textContent = micEnabled ? "Mic: ON (M)" : "Mic: OFF (M)";
      }
    }

    document.getElementById("calBtn").addEventListener("click", () => {
      if (typeof calibrateBackground === "function") calibrateBackground();
    });

    document.getElementById("recBtn").addEventListener("click", async () => {
      if (typeof toggleRecording === "function") await toggleRecording();
      refreshButtons();
    });

    document.getElementById("vidBtn").addEventListener("click", () => {
      if (typeof showVideo !== "undefined") showVideo = !showVideo;
    });

    document.getElementById("rstBtn").addEventListener("click", () => {
      if (typeof particles !== "undefined") particles = [];
    });

    document.getElementById("sndBtn").addEventListener("click", () => {
      if (typeof toggleSound === "function") toggleSound();
      refreshButtons();
    });

    document.getElementById("micBtn").addEventListener("click", async () => {
      if (typeof toggleMic === "function") await toggleMic();
      refreshButtons();
    });

    // Minimize UI so camera becomes visible
    const ui = document.getElementById("ui");
    const minBtn = document.getElementById("minBtn");

    function setCollapsed(v) {
      ui.classList.toggle("collapsed", v);
      minBtn.textContent = v ? "Expand" : "Minimize";
    }

    minBtn.addEventListener("click", () => {
      setCollapsed(!ui.classList.contains("collapsed"));
    });

    // Auto-collapse on small phones (best UX)
    if (window.matchMedia("(max-width: 480px)").matches) {
      setCollapsed(true);
    }

    // Unlock audio on first tap (mobile browser requirement)
    window.addEventListener("pointerdown", () => {
      if (typeof unlockAudio === "function") unlockAudio();
    }, { once: true });
  </script>
</body>

</html>